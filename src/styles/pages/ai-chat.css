/* ============================================================
   AI Chat — Floating Widget + Chat Panel
   Uses existing theme.css tokens throughout.
   Z-index 450: above modals (400), below toasts (500)
   ============================================================ */

/* ── Root wrapper ─────────────────────────────────────────── */
.ai-chat-root {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 450;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 12px;
  pointer-events: none; /* children opt back in */
}

/* ── Floating toggle button ───────────────────────────────── */
.ai-toggle-btn {
  pointer-events: all;
  width: 56px;
  height: 56px;
  border-radius: var(--radius-full);
  border: 2px solid var(--char-color, var(--accent-teal));
  background: var(--bg-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  box-shadow: 0 0 18px color-mix(in srgb, var(--char-color, var(--accent-teal)) 35%, transparent),
              var(--shadow-card);
  overflow: visible;
  flex-shrink: 0;
}

.ai-toggle-btn:hover {
  transform: scale(1.08);
  box-shadow: 0 0 28px color-mix(in srgb, var(--char-color, var(--accent-teal)) 55%, transparent),
              var(--shadow-card);
}

.ai-toggle-btn.open {
  box-shadow: 0 0 32px color-mix(in srgb, var(--char-color, var(--accent-teal)) 60%, transparent),
              var(--shadow-modal);
}

/* Pulsing ring when unread */
.ai-toggle-btn:has(.ai-unread-badge)::before {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: var(--radius-full);
  border: 2px solid var(--char-color, var(--accent-teal));
  animation: pulse-ring 2s ease-in-out infinite;
  pointer-events: none;
}

@keyframes pulse-ring {
  0%, 100% { opacity: 0.4; transform: scale(1); }
  50%       { opacity: 0;   transform: scale(1.25); }
}

.ai-toggle-avatar {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: var(--radius-full);
}

.ai-toggle-initials {
  font-size: var(--text-xl);
  font-weight: 700;
  color: var(--char-color, var(--accent-teal));
  font-family: var(--font-display);
  user-select: none;
}

.ai-unread-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  min-width: 20px;
  height: 20px;
  padding: 0 5px;
  border-radius: var(--radius-full);
  background: #ef4444;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--bg-primary);
}

/* ── Chat panel ───────────────────────────────────────────── */
.ai-chat-panel {
  pointer-events: all;
  width: 360px;
  height: 540px;
  display: flex;
  flex-direction: column;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--char-color, var(--accent-teal));
  border-radius: var(--radius-xl);
  box-shadow: 0 0 40px color-mix(in srgb, var(--char-color, var(--accent-teal)) 20%, transparent),
              var(--shadow-modal);
  overflow: hidden;
  animation: panel-slide-in 200ms ease;
}

@keyframes panel-slide-in {
  from { opacity: 0; transform: translateY(12px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0)     scale(1);    }
}

/* Panel header */
.ai-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px 10px 14px;
  border-bottom: 1px solid color-mix(in srgb, var(--char-color, var(--accent-teal)) 25%, transparent);
  background: color-mix(in srgb, var(--bg-secondary) 80%, transparent);
  flex-shrink: 0;
}

.ai-panel-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: var(--text-base);
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color var(--transition-fast), background var(--transition-fast);
  flex-shrink: 0;
}
.ai-panel-close:hover {
  color: var(--text-primary);
  background: var(--border-subtle);
}

/* ── Character selector ───────────────────────────────────── */
.char-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
  flex: 1;
}

.char-tabs {
  display: flex;
  gap: 4px;
}

.char-tab {
  width: 30px;
  height: 30px;
  border-radius: var(--radius-full);
  border: 2px solid transparent;
  background: var(--bg-surface);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  transition: border-color var(--transition-fast), transform var(--transition-fast),
              box-shadow var(--transition-fast);
  flex-shrink: 0;
}
.char-tab:hover {
  border-color: var(--char-color);
  transform: scale(1.1);
}
.char-tab.active {
  border-color: var(--char-color);
  box-shadow: 0 0 10px color-mix(in srgb, var(--char-color) 45%, transparent);
}

.char-tab-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: var(--radius-full);
}

.char-tab-initials {
  font-size: 12px;
  font-weight: 700;
  font-family: var(--font-display);
  user-select: none;
}

.char-active-name {
  font-size: var(--text-sm);
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.char-game-label {
  font-size: var(--text-xs);
  color: var(--text-muted);
  font-weight: 400;
}

/* ── Messages area ────────────────────────────────────────── */
.ai-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px 12px 8px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  scrollbar-width: thin;
  scrollbar-color: var(--border-dim) transparent;
}
.ai-messages::-webkit-scrollbar       { width: 4px; }
.ai-messages::-webkit-scrollbar-track { background: transparent; }
.ai-messages::-webkit-scrollbar-thumb { background: var(--border-dim); border-radius: 4px; }

/* Empty state */
.ai-empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 24px;
  text-align: center;
  color: var(--text-secondary);
}

.ai-empty-avatar {
  width: 64px;
  height: 64px;
  border-radius: var(--radius-full);
  border: 2px solid var(--char-color, var(--accent-teal));
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background: color-mix(in srgb, var(--char-color, var(--accent-teal)) 10%, transparent);
}
.ai-empty-avatar img  { width: 100%; height: 100%; object-fit: cover; }
.ai-empty-avatar span { font-size: 1.8rem; font-family: var(--font-display); }

.ai-empty-state p     { margin: 0; font-size: var(--text-sm); }
.ai-empty-hint        { color: var(--text-muted); font-size: var(--text-xs) !important; }

/* ── Message bubbles ──────────────────────────────────────── */
.msg-wrap {
  display: flex;
  gap: 8px;
  max-width: 92%;
  animation: msg-in 160ms ease;
}

@keyframes msg-in {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0);   }
}

.msg-user {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-ai {
  align-self: flex-start;
}

.msg-proactive .msg-bubble-ai {
  border-left-width: 3px !important;
  background: color-mix(in srgb, var(--char-color, var(--accent-teal)) 6%, var(--bg-secondary));
}

/* Avatar */
.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-full);
  border: 1.5px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
  align-self: flex-end;
}
.msg-avatar img  { width: 100%; height: 100%; object-fit: cover; }
.msg-avatar span { font-size: 12px; font-weight: 700; font-family: var(--font-display); }

/* Body */
.msg-body {
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 0;
}

.msg-char-name {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding-left: 2px;
}

.msg-proactive-icon { font-size: 11px; }

/* Image preview inside message */
.msg-image {
  max-width: 180px;
  max-height: 140px;
  border-radius: var(--radius-md);
  object-fit: cover;
  border: 1px solid var(--border-dim);
  margin-bottom: 2px;
}

/* Bubble */
.msg-bubble {
  padding: 8px 11px;
  border-radius: var(--radius-lg);
  font-size: var(--text-sm);
  line-height: 1.55;
  word-break: break-word;
  white-space: pre-wrap;
}

.msg-bubble-user {
  background: color-mix(in srgb, var(--accent-teal) 18%, var(--bg-secondary));
  border: 1px solid color-mix(in srgb, var(--accent-teal) 30%, transparent);
  color: var(--text-primary);
  border-bottom-right-radius: var(--radius-sm);
}

.msg-bubble-ai {
  background: var(--bg-surface);
  border: 1px solid var(--border-dim);
  border-left: 3px solid var(--char-color, var(--accent-teal));
  color: var(--text-primary);
  border-bottom-left-radius: var(--radius-sm);
}

/* Streaming cursor */
.streaming-cursor {
  display: inline-block;
  animation: blink 0.8s step-end infinite;
  color: var(--char-color, var(--accent-teal));
  margin-left: 1px;
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50%       { opacity: 0; }
}

/* Action notes */
.msg-actions {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-top: 2px;
  padding-left: 2px;
}

.msg-action-note {
  font-size: 11px;
  font-style: italic;
  opacity: 0.85;
}
.action-ok   { color: var(--priority-low);  }
.action-fail { color: var(--priority-high); }

/* ── Chat input ───────────────────────────────────────────── */
.chat-input-wrap {
  flex-shrink: 0;
  padding: 8px 10px 10px;
  border-top: 1px solid color-mix(in srgb, var(--char-color, var(--accent-teal)) 20%, transparent);
  background: color-mix(in srgb, var(--bg-secondary) 70%, transparent);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* Image preview above input */
.chat-img-preview {
  position: relative;
  align-self: flex-start;
}
.chat-img-preview img {
  max-height: 72px;
  max-width: 120px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-dim);
  object-fit: cover;
  display: block;
}
.chat-img-remove {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 18px;
  height: 18px;
  border-radius: var(--radius-full);
  background: #ef4444;
  color: #fff;
  border: none;
  cursor: pointer;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* Input row */
.chat-input-row {
  display: flex;
  align-items: flex-end;
  gap: 6px;
}

.chat-attach-btn {
  background: none;
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  transition: color var(--transition-fast), border-color var(--transition-fast);
  flex-shrink: 0;
}
.chat-attach-btn:hover:not(:disabled) {
  color: var(--char-color, var(--accent-teal));
  border-color: var(--char-color, var(--accent-teal));
}
.chat-attach-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.chat-textarea {
  flex: 1;
  background: var(--bg-input);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-family: var(--font-primary);
  font-size: var(--text-sm);
  line-height: 1.5;
  padding: 7px 10px;
  resize: none;
  min-height: 32px;
  max-height: 96px;
  transition: border-color var(--transition-fast);
  outline: none;
}
.chat-textarea:focus {
  border-color: var(--char-color, var(--accent-teal));
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--char-color, var(--accent-teal)) 15%, transparent);
}
.chat-textarea::placeholder { color: var(--text-disabled); }
.chat-textarea:disabled      { opacity: 0.5; cursor: not-allowed; }

.chat-send-btn {
  background: var(--border-dim);
  border: none;
  border-radius: var(--radius-md);
  color: var(--text-muted);
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  transition: background var(--transition-fast), color var(--transition-fast),
              box-shadow var(--transition-fast);
  flex-shrink: 0;
}
.chat-send-btn.active {
  background: var(--char-color, var(--accent-teal));
  color: var(--bg-primary);
  box-shadow: 0 0 12px color-mix(in srgb, var(--char-color, var(--accent-teal)) 45%, transparent);
}
.chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── Character selector — active info block ──────────────── */
.char-active-info {
  display: flex;
  flex-direction: column;
  gap: 1px;
  min-width: 0;
  flex: 1;
  overflow: hidden;
}

.char-relationship-label {
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.04em;
  opacity: 0.75;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ── Panel header — right-side actions group ─────────────── */
.ai-panel-header-actions {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}

/* Shared icon button style (settings + close) */
.ai-panel-icon-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: var(--text-base);
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color var(--transition-fast), background var(--transition-fast);
  flex-shrink: 0;
}
.ai-panel-icon-btn:hover {
  color: var(--text-primary);
  background: var(--border-subtle);
}

/* ── Settings dropdown ────────────────────────────────────── */
.ai-settings-wrapper {
  position: relative;
}

.ai-settings-dropdown {
  position: absolute;
  top: calc(100% + 6px);
  right: 0;
  min-width: 220px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-dim);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-modal);
  z-index: 20;
  overflow: hidden;
  animation: dropdown-in 140ms ease;
}

@keyframes dropdown-in {
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.ai-settings-section {
  padding: 8px;
  border-bottom: 1px solid var(--border-subtle);
}
.ai-settings-section:last-child {
  border-bottom: none;
}

.ai-settings-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  padding: 0 4px 4px;
  margin: 0;
}

.ai-settings-danger-btn {
  width: 100%;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: var(--text-sm);
  padding: 7px 10px;
  border-radius: var(--radius-md);
  text-align: left;
  transition: background var(--transition-fast), color var(--transition-fast);
  display: block;
}
.ai-settings-danger-btn:hover {
  background: color-mix(in srgb, #ef4444 12%, transparent);
  color: #ef4444;
}

.ai-settings-model-option {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 7px 10px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background var(--transition-fast);
}
.ai-settings-model-option:hover {
  background: var(--border-subtle);
}
.ai-settings-model-option input[type="radio"] {
  margin-top: 2px;
  accent-color: var(--char-color, var(--accent-teal));
  flex-shrink: 0;
}
.ai-settings-model-option span {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.ai-settings-model-option strong {
  font-size: var(--text-sm);
  color: var(--text-primary);
  font-weight: 600;
}
.ai-settings-model-desc {
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 400;
}

/* ── Relationship bar ─────────────────────────────────────── */
.ai-relationship-bar-wrap {
  flex-shrink: 0;
  height: 18px;
  position: relative;
  background: color-mix(in srgb, var(--char-color, var(--accent-teal)) 8%, var(--bg-secondary));
  border-bottom: 1px solid color-mix(in srgb, var(--char-color, var(--accent-teal)) 20%, transparent);
  overflow: hidden;
  cursor: default;
}

.ai-relationship-bar-fill {
  position: absolute;
  inset: 0;
  height: 100%;
  background: color-mix(in srgb, var(--char-color, var(--accent-teal)) 22%, transparent);
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  width: 0%;
}

.ai-relationship-label {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.05em;
  color: var(--char-color, var(--accent-teal));
  text-shadow: 0 1px 3px var(--bg-primary);
  user-select: none;
  pointer-events: none;
}

/* ── Fullscreen mode ──────────────────────────────────────── */
.ai-chat-root.fullscreen {
  inset: 0;
  width: auto;
  height: auto;
  align-items: stretch;
  justify-content: flex-start;
  gap: 0;
}

.ai-chat-root.fullscreen .ai-chat-panel {
  flex: 1;
  width: 100%;
  height: 0; /* flex: 1 overrides with min-height: 0 trick */
  min-height: 0;
  border-radius: 0;
  animation: fullscreen-in 200ms ease;
  box-shadow: none;
}

.ai-chat-root.fullscreen .ai-toggle-btn {
  display: none;
}

@keyframes fullscreen-in {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* Desktop fullscreen: cap width for readability */
@media (min-width: 769px) {
  .ai-chat-root.fullscreen {
    background: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
  }
  .ai-chat-root.fullscreen .ai-chat-panel {
    flex: none;
    width: min(720px, 90vw);
    height: min(860px, 90dvh);
    border-radius: var(--radius-xl);
    border: 1px solid var(--char-color, var(--accent-teal));
    box-shadow: 0 0 60px color-mix(in srgb, var(--char-color, var(--accent-teal)) 25%, transparent),
                var(--shadow-modal);
    animation: panel-slide-in 200ms ease;
  }
}

/* ── Responsive: mobile fixes ─────────────────────────────── */
@media (max-width: 480px) {
  .ai-chat-root {
    right: 8px;
    bottom: 12px;
  }

  .ai-chat-panel {
    /* width: fills viewport minus 8px margin on each side */
    width: calc(100vw - 16px);
    /* height: prevent overflow on small screens */
    height: min(520px, calc(100dvh - 90px));
  }

  /* Mobile fullscreen: truly full screen, no insets */
  .ai-chat-root.fullscreen .ai-chat-panel {
    width: 100%;
    height: 100%;
    border-radius: 0;
  }

  /* Tighten header on mobile */
  .ai-panel-header {
    padding: 8px 10px;
  }

  /* Slightly smaller char tabs on mobile */
  .char-tab {
    width: 28px;
    height: 28px;
  }

  /* Input area: prevent virtual keyboard overlap */
  .chat-input-wrap {
    padding-bottom: env(safe-area-inset-bottom, 10px);
  }
}
